<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–û–±—Ä–æ–±–∫–∞ –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .naklad-container { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
    .button-group { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
    button { padding: 6px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö</h1>

  <div id="nakladny-container"></div>
  <button onclick="addNakladnaField()">+ –î–æ–¥–∞—Ç–∏ –Ω–∞–∫–ª–∞–¥–Ω—É</button>
  <br /><br />
  <button onclick="processAll()">–û–ø—Ä–∞—Ü—é–≤–∞—Ç–∏</button>

  <div class="button-group" id="copy-buttons"></div>

  <script>
    function addNakladnaField() {
      const container = document.createElement("div");
      container.className = "naklad-container";
      container.innerHTML = `
        <input type="file" accept=".xlsx,.xlsm" required />
        <select>
          <option value="–ø—Ä–∏—Ö–æ–¥">–ø—Ä–∏—Ö—ñ–¥</option>
          <option value="–≤—ñ–¥—Ö–æ–¥">–≤—ñ–¥—Ö—ñ–¥</option>
        </select>
        <input type="text" placeholder="–ö–æ–ª–æ–Ω–∫–∞ (–Ω–∞–ø—Ä. C4)" maxlength="3" required />
      `;
      document.getElementById("nakladny-container").appendChild(container);
    }

    async function processAll() {
      const containers = document.querySelectorAll(".naklad-container");
      const formData = new FormData();
      const meta = [];

      let fileIndex = 0;
      for (const container of containers) {
        const fileInput = container.querySelector("input[type='file']");
        const operation = container.querySelector("select").value;
        const cell = container.querySelector("input[type='text']").value.trim().toUpperCase();

        if (!fileInput.files.length || !cell) continue;

        const file = fileInput.files[0];
        formData.append("nakladni", file); // —Ç–æ–π —Å–∞–º–∏–π key, –±–æ upload.array("nakladni")

        meta.push({ operation, cell });
        fileIndex++;
      }

      formData.append("meta", JSON.stringify(meta));

      const res = await fetch("/api/process-nakladni", {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö");
        return;
      }
      console.log("üëâ –†–µ–∑—É–ª—å—Ç–∞—Ç TSV –¥–ª—è zagalna –ù–ê–î–Ü–ô–®–õ–û:\n", response.zagalna["–ù–ê–î–Ü–ô–®–õ–û"]);
      const data = await res.json();
      renderCopyButtons(data);
    }

    function renderCopyButtons(data) {
      const buttonsDiv = document.getElementById("copy-buttons");
      buttonsDiv.innerHTML = "";

      const labels = {
        zagalna: "–ó–∞–≥–∞–ª—å–Ω–∞",
        khmilnyk: "–•–º—ñ–ª—å–Ω–∏–∫",
        koziatyn: "–ö–æ–∑—è—Ç–∏–Ω",
        kalynivka: "–ö–∞–ª–∏–Ω—ñ–≤–∫–∞",
      };

      for (const key of Object.keys(data)) {
        ["–ù–ê–î–Ü–ô–®–õ–û", "–í–ò–ë–£–õ–û"].forEach((sheet) => {
          const btn = document.createElement("button");
          btn.innerText = `${labels[key]}: ${sheet}`;
          btn.onclick = () => {
            navigator.clipboard.writeText(data[key][sheet]);
            alert(`–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ: ${labels[key]} - ${sheet}`);
          };
          buttonsDiv.appendChild(btn);
        });
      }
    }

    // –î–æ–¥–∞–π –æ–¥–Ω–µ –ø–æ–ª–µ –æ–¥—Ä–∞–∑—É
    addNakladnaField();
  </script>
</body>
</html>
